name: Y12.AI ISO Build

on:
  workflow_dispatch:
    inputs:
      job_id:
        description: 'Build job ID from the Y12 API'
        required: true
      api_url:
        description: 'Y12 API base URL'
        required: false
        default: 'https://y12-api.seefeldmaxwell1.workers.dev'

jobs:
  build-iso:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      - name: Report started
        run: |
          curl -s -X POST "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/progress" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BUILD_SECRET }}" \
            -d '{"progress": 5, "status": "building", "log": "GitHub Actions runner started"}'

      - name: Download build artifacts from R2
        run: |
          mkdir -p build && cd build
          for file in kernel.config build.sh Dockerfile docker-compose.yml manifest.json; do
            echo "Downloading $file..."
            curl -sf "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/file/$file" -o "$file" || echo "WARN: $file not available"
          done
          ls -la
          echo "--- kernel.config (first 20 lines) ---"
          head -20 kernel.config || true
          echo "--- Dockerfile (first 20 lines) ---"
          head -20 Dockerfile || true

      - name: Report downloading complete
        run: |
          curl -s -X POST "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/progress" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BUILD_SECRET }}" \
            -d '{"progress": 10, "log": "Build artifacts downloaded from R2"}'

      - name: Build ISO via Docker
        working-directory: build
        run: |
          set -e
          mkdir -p output

          curl -s -X POST "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/progress" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BUILD_SECRET }}" \
            -d '{"progress": 15, "log": "Starting Docker build..."}'

          echo "=== Dockerfile ==="
          cat Dockerfile
          echo "=== kernel.config ==="
          cat kernel.config
          echo "=== Starting docker build ==="

          # Build with --progress=plain so we see all output, capture exit code
          set +e
          docker build --progress=plain -t y12-iso-builder . 2>&1 | tee /tmp/docker-build.log
          BUILD_EXIT=${PIPESTATUS[0]}
          set -e

          # Report progress milestones from the log
          if grep -q "git clone" /tmp/docker-build.log; then
            curl -s -X POST "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/progress" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.BUILD_SECRET }}" \
              -d '{"progress": 30, "log": "Kernel source cloned"}' 2>/dev/null || true
          fi
          if grep -q "bzImage" /tmp/docker-build.log; then
            curl -s -X POST "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/progress" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.BUILD_SECRET }}" \
              -d '{"progress": 60, "log": "Kernel compiled (bzImage)"}' 2>/dev/null || true
          fi
          if grep -q "grub\|xorriso\|mkisofs" /tmp/docker-build.log; then
            curl -s -X POST "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/progress" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.BUILD_SECRET }}" \
              -d '{"progress": 85, "log": "ISO created with bootloader"}' 2>/dev/null || true
          fi

          if [ "$BUILD_EXIT" -ne 0 ]; then
            LAST_LINES=$(tail -30 /tmp/docker-build.log | tr '\n' ' ' | cut -c1-500)
            curl -s -X POST "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/progress" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.BUILD_SECRET }}" \
              -d "{\"progress\": 50, \"status\": \"failed\", \"log\": \"Docker build failed: ${LAST_LINES}\"}" 2>/dev/null || true
            echo "Docker build failed with exit code $BUILD_EXIT"
            echo "=== Last 50 lines of build log ==="
            tail -50 /tmp/docker-build.log
            exit 1
          fi

          echo "=== Docker build succeeded, extracting ISO ==="
          EXTRACT_ID=$(docker create y12-iso-builder)
          docker cp "$EXTRACT_ID:/output.iso" output/output.iso || true
          docker cp "$EXTRACT_ID:/output.iso.sha256" output/output.iso.sha256 || true
          docker rm "$EXTRACT_ID"

          echo "=== Output files ==="
          ls -lh output/

      - name: Verify ISO
        working-directory: build
        run: |
          if [ ! -f output/output.iso ]; then
            echo "ERROR: ISO file not produced!"
            curl -s -X POST "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/progress" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.BUILD_SECRET }}" \
              -d '{"progress": 95, "status": "failed", "log": "ISO file was not produced by Docker build"}'
            exit 1
          fi

          ISO_SIZE=$(stat -c%s output/output.iso)
          ISO_SHA=$(sha256sum output/output.iso | cut -d' ' -f1)
          ISO_TYPE=$(file output/output.iso)

          echo "ISO size: $ISO_SIZE bytes"
          echo "ISO SHA256: $ISO_SHA"
          echo "ISO type: $ISO_TYPE"

          # Verify it's actually an ISO
          if echo "$ISO_TYPE" | grep -qi "ISO 9660\|boot sector\|DOS/MBR"; then
            echo "✓ Valid ISO file detected"
          else
            echo "⚠ File type may not be a standard ISO: $ISO_TYPE"
          fi

          # Verify minimum size (a real ISO with rootfs should be at least 200MB)
          if [ "$ISO_SIZE" -lt 200000000 ]; then
            echo "⚠ ISO is suspiciously small ($ISO_SIZE bytes) — may be missing rootfs"
          else
            echo "✓ ISO size looks reasonable ($ISO_SIZE bytes)"
          fi

          curl -s -X POST "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/progress" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BUILD_SECRET }}" \
            -d "{\"progress\": 92, \"log\": \"ISO verified: ${ISO_SIZE} bytes, SHA256: ${ISO_SHA}\"}"

      - name: Upload ISO to R2 via multipart API
        working-directory: build
        run: |
          API_URL="${{ inputs.api_url }}"
          JOB_ID="${{ inputs.job_id }}"
          AUTH="Bearer ${{ secrets.BUILD_SECRET }}"
          ISO_FILE="output/output.iso"
          ISO_SHA=$(sha256sum "$ISO_FILE" | cut -d' ' -f1)
          ISO_SIZE=$(stat -c%s "$ISO_FILE")
          CHUNK_SIZE=90000000  # ~90MB chunks (under CF 100MB limit)

          curl -s -X POST "$API_URL/api/build/$JOB_ID/progress" \
            -H "Content-Type: application/json" \
            -H "Authorization: $AUTH" \
            -d "{\"progress\": 95, \"log\": \"Uploading ISO to R2 (${ISO_SIZE} bytes, multipart)...\"}"

          echo "ISO: ${ISO_SIZE} bytes, SHA256: ${ISO_SHA}"

          # Step 1: Start multipart upload
          START_RESP=$(curl -s -X POST "$API_URL/api/build/$JOB_ID/upload-iso/start" \
            -H "Authorization: $AUTH" \
            -H "Content-Type: application/json")
          UPLOAD_ID=$(echo "$START_RESP" | python3 -c "import sys,json; print(json.load(sys.stdin).get('uploadId',''))" 2>/dev/null || echo "")

          if [ -z "$UPLOAD_ID" ]; then
            echo "ERROR: Failed to start multipart upload: $START_RESP"
            exit 1
          fi
          echo "Multipart upload started: $UPLOAD_ID"

          # Step 2: Split and upload parts
          split -b $CHUNK_SIZE -d "$ISO_FILE" /tmp/iso_part_
          PARTS_JSON="["
          PART_NUM=0
          for PART_FILE in /tmp/iso_part_*; do
            PART_NUM=$((PART_NUM + 1))
            PART_SIZE=$(stat -c%s "$PART_FILE")
            echo "Uploading part $PART_NUM ($PART_SIZE bytes)..."

            PART_RESP=$(curl -s -X PUT "$API_URL/api/build/$JOB_ID/upload-iso/part" \
              -H "Authorization: $AUTH" \
              -H "Content-Type: application/octet-stream" \
              -H "X-Upload-Id: $UPLOAD_ID" \
              -H "X-Part-Number: $PART_NUM" \
              --data-binary @"$PART_FILE")

            ETAG=$(echo "$PART_RESP" | python3 -c "import sys,json; print(json.load(sys.stdin).get('etag',''))" 2>/dev/null || echo "")
            if [ -z "$ETAG" ]; then
              echo "ERROR: Part $PART_NUM upload failed: $PART_RESP"
              exit 1
            fi
            echo "Part $PART_NUM uploaded, etag: $ETAG"

            if [ $PART_NUM -gt 1 ]; then PARTS_JSON="$PARTS_JSON,"; fi
            PARTS_JSON="$PARTS_JSON{\"partNumber\":$PART_NUM,\"etag\":\"$ETAG\"}"
            rm -f "$PART_FILE"
          done
          PARTS_JSON="$PARTS_JSON]"

          # Step 3: Complete multipart upload
          COMPLETE_BODY="{\"uploadId\":\"$UPLOAD_ID\",\"parts\":$PARTS_JSON,\"sha256\":\"$ISO_SHA\",\"size\":$ISO_SIZE}"
          COMPLETE_RESP=$(curl -s -X POST "$API_URL/api/build/$JOB_ID/upload-iso/complete" \
            -H "Authorization: $AUTH" \
            -H "Content-Type: application/json" \
            -d "$COMPLETE_BODY")

          echo "Complete response: $COMPLETE_RESP"
          OK=$(echo "$COMPLETE_RESP" | python3 -c "import sys,json; print(json.load(sys.stdin).get('ok',False))" 2>/dev/null || echo "")
          if [ "$OK" != "True" ]; then
            echo "ERROR: Multipart complete failed: $COMPLETE_RESP"
            exit 1
          fi

          echo "ISO uploaded to R2 successfully via multipart upload"
          sleep 2

      - name: Report complete
        if: success()
        run: |
          ISO_SHA=$(sha256sum build/output/output.iso | cut -d' ' -f1)
          ISO_SIZE=$(stat -c%s build/output/output.iso)
          curl -s -X POST "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/progress" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BUILD_SECRET }}" \
            -d "{\"progress\": 100, \"status\": \"complete\", \"log\": \"ISO build complete. Size: ${ISO_SIZE} bytes. SHA256: ${ISO_SHA}. Uploaded to R2.\"}"

      - name: Report failure
        if: failure()
        run: |
          curl -s -X POST "${{ inputs.api_url }}/api/build/${{ inputs.job_id }}/progress" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.BUILD_SECRET }}" \
            -d '{"status": "failed", "log": "GitHub Actions build failed. Check workflow logs."}' || true
